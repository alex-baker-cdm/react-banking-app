name: Devin CI Checks

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  ui-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - test_name: sign_in_flow
            playbook_id: playbook-1bf0331c2295428f9e6bd459c84ce119
            prompt: "Run the Sign In Flow Test playbook for the react-banking-app repository."
          - test_name: transactions_page_flow
            playbook_id: playbook-20a3952e736a455eb1ab381b7797270d
            prompt: "Run the Transactions Page Flow Test playbook for the react-banking-app repository."
          - test_name: savings_currency_selection
            playbook_id: playbook-61fe238917054a1f89cbc8d4a802ae7e
            prompt: "Run the Savings Currency Selection Flow Test playbook for the react-banking-app repository."
          - test_name: cards_page_flow
            playbook_id: playbook-fadaef21379b4d8c878914fed798a444
            prompt: "Run the Cards Page Flow Test playbook for the react-banking-app repository."
          - test_name: profile_page_flow
            playbook_id: playbook-a2eb4a5ba8784d73bf33b9a85477c2bb
            prompt: "Run the Profile Page Flow Test playbook for the react-banking-app repository."
          - test_name: sign_out_flow
            playbook_id: playbook-sign-out-flow-test
            prompt: "Test the sign-out flow for the react-banking-app repository. Steps: 1) Start the app locally with yarn start, 2) Sign in with any email and password, 3) Click the profile icon to navigate to the profile page, 4) Click the Sign out button at the bottom of the profile page, 5) Verify that the user is redirected back to the sign-in page. Report test_passed=true if the sign-out redirects to the sign-in page successfully, otherwise report test_passed=false with details."
    
    steps:
      - name: Create Devin Session
        id: create-session
        env:
          DEVIN_API_KEY_V3: ${{ secrets.DEVIN_API_KEY_V3 }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_PLAYBOOK_ID: ${{ matrix.playbook_id }}
          DEVIN_PROMPT: ${{ matrix.prompt }}
        run: |
          echo "Creating Devin session for ${{ matrix.test_name }}..."
          
          RESPONSE=$(curl -s --request POST \
            --url "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            --header "Authorization: Bearer ${DEVIN_API_KEY_V3}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"prompt\": \"${DEVIN_PROMPT}\",
              \"playbook_id\": \"${DEVIN_PLAYBOOK_ID}\"
            }")
          
          echo "Response: $RESPONSE"
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "Failed to create session"
            exit 1
          fi
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Created session: $SESSION_ID"

      - name: Wait for Session to Complete
        id: wait-session
        env:
          DEVIN_API_KEY_V1: ${{ secrets.DEVIN_API_KEY_V1 }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Waiting for session $SESSION_ID to complete..."
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --request GET \
              --url "https://api.devin.ai/v1/sessions/${SESSION_ID}" \
              --header "Authorization: Bearer ${DEVIN_API_KEY_V1}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status_enum')
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" == "finished" ] || [ "$STATUS" == "stopped" ] || [ "$STATUS" == "suspended" ] || [ "$STATUS" == "blocked" ]; then
              echo "Session completed with status: $STATUS"
              
              STRUCTURED_OUTPUT=$(echo "$RESPONSE" | jq -c '.structured_output')
              echo "structured_output=$STRUCTURED_OUTPUT" >> $GITHUB_OUTPUT
              
              TEST_PASSED=$(echo "$RESPONSE" | jq -r '.structured_output.test_passed // false')
              echo "test_passed=$TEST_PASSED" >> $GITHUB_OUTPUT
              
              DETAILS=$(echo "$RESPONSE" | jq -r '.structured_output.details // "No details"')
              echo "details=$DETAILS" >> $GITHUB_OUTPUT
              
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Session timed out"
            echo "test_passed=false" >> $GITHUB_OUTPUT
            echo "details=Session timed out after 15 minutes" >> $GITHUB_OUTPUT
          fi

      - name: Check Test Results
        env:
          TEST_PASSED: ${{ steps.wait-session.outputs.test_passed }}
          DETAILS: ${{ steps.wait-session.outputs.details }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
          TEST_NAME: ${{ matrix.test_name }}
        run: |
          echo "Test Results for $TEST_NAME:"
          echo "  Passed: $TEST_PASSED"
          echo "  Details: $DETAILS"
          echo "  Session: https://app.devin.ai/sessions/$SESSION_ID"
          
          if [ "$TEST_PASSED" != "true" ]; then
            echo "UI test $TEST_NAME failed!"
            exit 1
          fi
          
          echo "UI test $TEST_NAME passed!"

  documentation-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Create Devin Session
        id: create-session
        env:
          DEVIN_API_KEY_V3: ${{ secrets.DEVIN_API_KEY_V3 }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_PLAYBOOK_ID: "playbook-f50d643119a0491b89c2a74765931e1c"
        run: |
          echo "Creating Devin session for documentation check..."
          
          RESPONSE=$(curl -s --request POST \
            --url "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            --header "Authorization: Bearer ${DEVIN_API_KEY_V3}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"prompt\": \"Run the Documentation Update Check playbook for the react-banking-app repository.\",
              \"playbook_id\": \"${DEVIN_PLAYBOOK_ID}\"
            }")
          
          echo "Response: $RESPONSE"
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "Failed to create session"
            exit 1
          fi
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Created session: $SESSION_ID"

      - name: Wait for Session to Complete
        id: wait-session
        env:
          DEVIN_API_KEY_V1: ${{ secrets.DEVIN_API_KEY_V1 }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Waiting for session $SESSION_ID to complete..."
          
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --request GET \
              --url "https://api.devin.ai/v1/sessions/${SESSION_ID}" \
              --header "Authorization: Bearer ${DEVIN_API_KEY_V1}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status_enum')
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" == "finished" ] || [ "$STATUS" == "stopped" ] || [ "$STATUS" == "suspended" ] || [ "$STATUS" == "blocked" ]; then
              echo "Session completed with status: $STATUS"
              
              STRUCTURED_OUTPUT=$(echo "$RESPONSE" | jq -c '.structured_output')
              echo "structured_output=$STRUCTURED_OUTPUT" >> $GITHUB_OUTPUT
              
              CHECK_PASSED=$(echo "$RESPONSE" | jq -r '.structured_output.check_passed // false')
              echo "check_passed=$CHECK_PASSED" >> $GITHUB_OUTPUT
              
              DETAILS=$(echo "$RESPONSE" | jq -r '.structured_output.details // "No details"')
              echo "details=$DETAILS" >> $GITHUB_OUTPUT
              
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Session timed out"
            echo "check_passed=false" >> $GITHUB_OUTPUT
            echo "details=Session timed out after 10 minutes" >> $GITHUB_OUTPUT
          fi

      - name: Check Results
        env:
          CHECK_PASSED: ${{ steps.wait-session.outputs.check_passed }}
          DETAILS: ${{ steps.wait-session.outputs.details }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Documentation Check Results:"
          echo "  Passed: $CHECK_PASSED"
          echo "  Details: $DETAILS"
          echo "  Session: https://app.devin.ai/sessions/$SESSION_ID"
          
          if [ "$CHECK_PASSED" != "true" ]; then
            echo "Documentation check failed!"
            exit 1
          fi
          
          echo "Documentation check passed!"

  cross-repo-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Create Devin Session
        id: create-session
        env:
          DEVIN_API_KEY_V3: ${{ secrets.DEVIN_API_KEY_V3 }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_PLAYBOOK_ID: "playbook-1c65933f913f48f582399ab27d55a20d"
        run: |
          echo "Creating Devin session for cross-repo dependency check..."
          
          RESPONSE=$(curl -s --request POST \
            --url "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            --header "Authorization: Bearer ${DEVIN_API_KEY_V3}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"prompt\": \"Run the Cross-Repo Dependency Check playbook for the react-banking-app repository.\",
              \"playbook_id\": \"${DEVIN_PLAYBOOK_ID}\"
            }")
          
          echo "Response: $RESPONSE"
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "Failed to create session"
            exit 1
          fi
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Created session: $SESSION_ID"

      - name: Wait for Session to Complete
        id: wait-session
        env:
          DEVIN_API_KEY_V1: ${{ secrets.DEVIN_API_KEY_V1 }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Waiting for session $SESSION_ID to complete..."
          
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --request GET \
              --url "https://api.devin.ai/v1/sessions/${SESSION_ID}" \
              --header "Authorization: Bearer ${DEVIN_API_KEY_V1}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status_enum')
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" == "finished" ] || [ "$STATUS" == "stopped" ] || [ "$STATUS" == "suspended" ] || [ "$STATUS" == "blocked" ]; then
              echo "Session completed with status: $STATUS"
              
              STRUCTURED_OUTPUT=$(echo "$RESPONSE" | jq -c '.structured_output')
              echo "structured_output=$STRUCTURED_OUTPUT" >> $GITHUB_OUTPUT
              
              CHECK_PASSED=$(echo "$RESPONSE" | jq -r '.structured_output.check_passed // false')
              echo "check_passed=$CHECK_PASSED" >> $GITHUB_OUTPUT
              
              DETAILS=$(echo "$RESPONSE" | jq -r '.structured_output.details // "No details"')
              echo "details=$DETAILS" >> $GITHUB_OUTPUT
              
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Session timed out"
            echo "check_passed=false" >> $GITHUB_OUTPUT
            echo "details=Session timed out after 10 minutes" >> $GITHUB_OUTPUT
          fi

      - name: Check Results
        env:
          CHECK_PASSED: ${{ steps.wait-session.outputs.check_passed }}
          DETAILS: ${{ steps.wait-session.outputs.details }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Cross-Repo Dependency Check Results:"
          echo "  Passed: $CHECK_PASSED"
          echo "  Details: $DETAILS"
          echo "  Session: https://app.devin.ai/sessions/$SESSION_ID"
          
          if [ "$CHECK_PASSED" != "true" ]; then
            echo "Cross-repo dependency check failed!"
            exit 1
          fi
          
          echo "Cross-repo dependency check passed!"

  sca-vulnerability-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Create Devin Session
        id: create-session
        env:
          DEVIN_API_KEY_V3: ${{ secrets.DEVIN_API_KEY_V3 }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_PLAYBOOK_ID: "playbook-88e89fadd5c141c6bd5e5942b0e31ba8"
        run: |
          echo "Creating Devin session for SCA vulnerability check..."
          
          RESPONSE=$(curl -s --request POST \
            --url "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            --header "Authorization: Bearer ${DEVIN_API_KEY_V3}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"prompt\": \"Run the SCA Vulnerability Check playbook. Repository: ${{ github.repository }}, PR #${{ github.event.pull_request.number }}, Branch: ${{ github.head_ref }}. Clone the repo, checkout the PR branch (${{ github.head_ref }}), run the Snyk SCA scan, and if you find simple fixes, push them to the ${{ github.head_ref }} branch.\",
              \"playbook_id\": \"${DEVIN_PLAYBOOK_ID}\"
            }")
          
          echo "Response: $RESPONSE"
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "Failed to create session"
            exit 1
          fi
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Created session: $SESSION_ID"

      - name: Wait for Session to Complete
        id: wait-session
        env:
          DEVIN_API_KEY_V1: ${{ secrets.DEVIN_API_KEY_V1 }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Waiting for session $SESSION_ID to complete..."
          
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --request GET \
              --url "https://api.devin.ai/v1/sessions/${SESSION_ID}" \
              --header "Authorization: Bearer ${DEVIN_API_KEY_V1}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status_enum')
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" == "finished" ] || [ "$STATUS" == "stopped" ] || [ "$STATUS" == "suspended" ] || [ "$STATUS" == "blocked" ]; then
              echo "Session completed with status: $STATUS"
              
              STRUCTURED_OUTPUT=$(echo "$RESPONSE" | jq -c '.structured_output')
              echo "structured_output=$STRUCTURED_OUTPUT" >> $GITHUB_OUTPUT
              
              CHECK_PASSED=$(echo "$RESPONSE" | jq -r '.structured_output.check_passed // false')
              echo "check_passed=$CHECK_PASSED" >> $GITHUB_OUTPUT
              
              DETAILS=$(echo "$RESPONSE" | jq -r '.structured_output.details // "No details"')
              echo "details=$DETAILS" >> $GITHUB_OUTPUT
              
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Session timed out"
            echo "check_passed=false" >> $GITHUB_OUTPUT
            echo "details=Session timed out after 10 minutes" >> $GITHUB_OUTPUT
          fi

      - name: Check Results
        env:
          CHECK_PASSED: ${{ steps.wait-session.outputs.check_passed }}
          DETAILS: ${{ steps.wait-session.outputs.details }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "SCA Vulnerability Check Results:"
          echo "  Passed: $CHECK_PASSED"
          echo "  Details: $DETAILS"
          echo "  Session: https://app.devin.ai/sessions/$SESSION_ID"
          
          if [ "$CHECK_PASSED" != "true" ]; then
            echo "SCA vulnerability check failed!"
            exit 1
          fi
          
          echo "SCA vulnerability check passed!"
