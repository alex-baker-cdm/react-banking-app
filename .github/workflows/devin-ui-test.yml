name: Devin UI Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  ui-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - test_name: sign_in_flow
            playbook_id: playbook-1bf0331c2295428f9e6bd459c84ce119
            prompt: "Run the Sign In Flow Test playbook for the react-banking-app repository."
          - test_name: transactions_page_flow
            playbook_id: playbook-20a3952e736a455eb1ab381b7797270d
            prompt: "Run the Transactions Page Flow Test playbook for the react-banking-app repository."
          - test_name: savings_currency_selection
            playbook_id: playbook-61fe238917054a1f89cbc8d4a802ae7e
            prompt: "Run the Savings Currency Selection Flow Test playbook for the react-banking-app repository."
          - test_name: cards_page_flow
            playbook_id: playbook-fadaef21379b4d8c878914fed798a444
            prompt: "Run the Cards Page Flow Test playbook for the react-banking-app repository."
          - test_name: profile_page_flow
            playbook_id: playbook-a2eb4a5ba8784d73bf33b9a85477c2bb
            prompt: "Run the Profile Page Flow Test playbook for the react-banking-app repository."
    
    steps:
      - name: Create Devin Session
        id: create-session
        env:
          DEVIN_API_KEY_V3: ${{ secrets.DEVIN_API_KEY_V3 }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          DEVIN_PLAYBOOK_ID: ${{ matrix.playbook_id }}
          DEVIN_PROMPT: ${{ matrix.prompt }}
        run: |
          echo "Creating Devin session for ${{ matrix.test_name }}..."
          
          RESPONSE=$(curl -s --request POST \
            --url "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            --header "Authorization: Bearer ${DEVIN_API_KEY_V3}" \
            --header 'Content-Type: application/json' \
            --data "{
              \"prompt\": \"${DEVIN_PROMPT}\",
              \"playbook_id\": \"${DEVIN_PLAYBOOK_ID}\"
            }")
          
          echo "Response: $RESPONSE"
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "Failed to create session"
            exit 1
          fi
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Created session: $SESSION_ID"

      - name: Wait for Session to Complete
        id: wait-session
        env:
          DEVIN_API_KEY_V1: ${{ secrets.DEVIN_API_KEY_V1 }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
        run: |
          echo "Waiting for session $SESSION_ID to complete..."
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --request GET \
              --url "https://api.devin.ai/v1/sessions/${SESSION_ID}" \
              --header "Authorization: Bearer ${DEVIN_API_KEY_V1}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status_enum')
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" == "finished" ] || [ "$STATUS" == "stopped" ] || [ "$STATUS" == "suspended" ] || [ "$STATUS" == "blocked" ]; then
              echo "Session completed with status: $STATUS"
              
              STRUCTURED_OUTPUT=$(echo "$RESPONSE" | jq -c '.structured_output')
              echo "structured_output=$STRUCTURED_OUTPUT" >> $GITHUB_OUTPUT
              
              TEST_PASSED=$(echo "$RESPONSE" | jq -r '.structured_output.test_passed // false')
              echo "test_passed=$TEST_PASSED" >> $GITHUB_OUTPUT
              
              DETAILS=$(echo "$RESPONSE" | jq -r '.structured_output.details // "No details"')
              echo "details=$DETAILS" >> $GITHUB_OUTPUT
              
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 15
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Session timed out"
            echo "test_passed=false" >> $GITHUB_OUTPUT
            echo "details=Session timed out after 15 minutes" >> $GITHUB_OUTPUT
          fi

      - name: Check Test Results
        env:
          TEST_PASSED: ${{ steps.wait-session.outputs.test_passed }}
          DETAILS: ${{ steps.wait-session.outputs.details }}
          SESSION_ID: ${{ steps.create-session.outputs.session_id }}
          TEST_NAME: ${{ matrix.test_name }}
        run: |
          echo "Test Results for $TEST_NAME:"
          echo "  Passed: $TEST_PASSED"
          echo "  Details: $DETAILS"
          echo "  Session: https://app.devin.ai/sessions/$SESSION_ID"
          
          if [ "$TEST_PASSED" != "true" ]; then
            echo "UI test $TEST_NAME failed!"
            exit 1
          fi
          
          echo "UI test $TEST_NAME passed!"
